<!-- Group 7 - YuGiOmni - Matt Bauchspies/Jacob Erickson/Elias Peterson-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://bootswatch.com/5/darkly/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="./style.css" />
    <title>YuGiOmni</title>
</head>

<body>
    <!--Title of the webpage-->
    <div class="title col-sm-12 p-2 bg-secondary">
        <div class="container">
            <h3>YuGiOmni Card Database</h3>
            <p><a href="https://github.com/osDreamscape">Matt Bauchspies</a>,
                <a href="https://github.com/jae253">Jacob Erickson</a>,
                Elias Peterson <br>
            </p>
        </div>
    </div>

    <!--Container for the tabs the webpage utilizes-->
    <div class="container my-5">
        <!--Tabs for the webpage-->
        <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <!--Home tab-->
                <button class="nav-link active" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-home"
                    type="button" role="tab" aria-controls="nav-home" aria-selected="true">Home</button>

                <!--Monster Card Queries tab-->
                <button class="nav-link" id="nav-monster-tab" data-bs-toggle="tab" data-bs-target="#nav-monster"
                    type="button" role="tab" aria-controls="nav-monster" aria-selected="false">Monster Cards</button>

                <!--Trap Card Queries tab-->
                <button class="nav-link" id="nav-example-tab" data-bs-toggle="tab" data-bs-target="#nav-example" type="button"
                    role="tab" aria-controls="nav-example" aria-selected="false">Example Queries</button>

                <!--Debugging/arbitrary query tab-->
                <button class="nav-link" id="nav-query-tab" data-bs-toggle="tab" data-bs-target="#nav-query"
                    type="button" role="tab" aria-controls="nav-query" aria-selected="false">Custom Query</button>
            </div>

        </nav>
    </div>

    <!--Content for the individual tabs of the webpage-->
    <div class="tab-content" id="nav-tabContent">

        <!--Home tab content-->
        <div class="tab-pane fade show active p-3" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
            <img src="logo.png" class="center">
            <h1>About this page:</h1>
            <p>This page utilizes a Google Cloud hosted MySQL database for our data and Express for hosting the backend
                server. The backend utilizes Node.js to handle API requests from the HTML frontend. The frontend also
                uses Bootstrap and Jquery, as well as raw Javascript to handle events and send API requests to the
                backend, and update the HTML asyncronously.<br>

            </p>
        </div>

        <!--Monster tab content-->
        <div class="tab-pane fade p-3" id="nav-monster" role="tabpanel" aria-labelledby="nav-monster-tab">
            <h1>Monster Cards</h1>
            <div class="mb-3">

                <form>
                    <!-- Card type selection -->
                    <label for="monster_card_type" class="form-label">Select card type:</label>
                    <select class="form-select form-select-lg mb-3" aria-label=".form-select-lg monster_card_type"
                        id="monster_card_type">
                        <option value="Wildcard" selected>Any type</option>
                        <option value="Aqua">Aqua</option>
                        <option value="Beast">Beast</option>
                        <option value="Beast-Warrior">Beast-Warrior</option>
                        <option value="Cyberse">Cyberse</option>
                        <option value="Dinosaur">Dinosaur</option>
                        <option value="Divine-Beast">Divine-Beast</option>
                        <option value="Dragon">Dragon</option>
                        <option value="Fairy">Fairy</option>
                        <option value="Fiend">Fiend</option>
                        <option value="Fish">Fish</option>
                        <option value="Insect">Insect</option>
                        <option value="Machine">Machine</option>
                        <option value="Plant">Plant</option>
                        <option value="Psychic">Psychic</option>
                        <option value="Pyro">Pyro</option>
                        <option value="Reptile">Reptile</option>
                        <option value="Rock">Rock</option>
                        <option value="Sea Serpent">Sea Serpent</option>
                        <option value="Spellcaster">Spellcaster</option>
                        <option value="Thunder">Thunder</option>
                        <option value="Warrior">Warrior</option>
                        <option value="Winged Beast">Winged Beast</option>
                        <option value="Wyrm">Wyrm</option>
                        <option value="Zombie">Zombie</option>
                    </select>
                </form>
                <button type="submit" class="btn btn-primary" id="monsterquerysubmit">Search</button>
            </div>
            <div class="mb-3">
                <!--Text entry for the attribute(s)-->
                <label for="select" class="form-label">Alternatively, search by name:</label>
                <input type="text" class="form-control" id="monster_card_name" placeholder="Name of card">
            </div>
            <button type="submit" class="btn btn-primary" id="monsterquerynamesubmit">Search by name</button>
            
            <table id="monster-query-results"></table>

        </div>

        <!--Query tab content-->
        <div class="tab-pane fade p-3" id="nav-example" role="tabpanel" aria-labelledby="nav-example-tab">
            <h1>Example Queries</h1>
            <p>These are some example queries, which can be called by simply pressing the respective button:</p>
            <div class="trap-container">
                <button type="submit" class="btn btn-primary" id="monsteratkdefquery">Monsters with same
                    ATK/DEF</button><br>
                <button type="submit" class="btn btn-primary" id="monstercountrarityquery">Count of Rare+ monster cards and attributes</button><br>
                <button type="submit" class="btn btn-primary" id="monster_spell_lp_query">Spell cards that can affect Life Points</button><br>
                <button type="submit" class="btn btn-primary" id="monster_max_attack_query">Highest attack value in each Monster card attribute</button><br>
            </div>
            <table id="trap-query-results"></table>
        </div>

        <!--Spell tab content-->
        <!--TODO: this tab-->
        <div class="tab-pane fade p-3" id="nav-spell" role="tabpanel" aria-labelledby="nav-spell-tab">
            <h1>Spell Cards</h1>
            <div class="spell-container">

            </div>
        </div>

        <!--Custom Query tab content-->
        <div class="tab-pane fade p-3" id="nav-query" role="tabpanel">
            <h1>Arbitrary query</h1>
            <p>Disclaimer: this tab is meant to be used for debugging. While there is some protection against SQL injection using Regex, please be gentle when entering your custom queries. Much appreciated.</p>
            <div class="query-container">
                <form>
                    <div class="mb-3">
                        <!--Text entry for the attribute(s)-->
                        <label for="select" class="form-label">SELECT:</label>
                        <input type="text" class="form-control" id="select" placeholder="card_name, card_id">
                    </div>

                    <div class="mb-3">
                        <!--Select from predefined tables-->
                        <label for="from" class="form-label">FROM:</label>
                        <select class="form-select form-select-lg mb-3" aria-label=".form-select-lg boost" id="from">
                            <option value="card_names" selected>Card Names</option>
                            <option value="monster_cards">Monster Cards</option>
                            <option value="spell_cards">Spell Cards</option>
                            <option value="trap_cards">Trap Cards</option>
                            <option value="set_names">Set Names</option>
                            <option value="card_sets">Card Sets</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="where" class="form-label">WHERE:</label>
                        <input type="text" class="form-control" id="where" placeholder="card_name='Pot of Greed'">
                    </div>
                </form>
                <button type="submit" class="btn btn-primary" id="querysubmit">Execute query</button>
                <br>
                <!--Output of the calculations-->
                <br>
                <table id="custom-query-results"></table>

            </div>
        </div>

    </div>


    <!--import bootstrap and jquery at the end to load page quicker-->
    <script src="http://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
</body>
<script>
    let RESTAPI = `http://127.0.0.1:3000`

    // Sends a request to the localhost API to query the database
    $("#querysubmit").click(function () {
        const selection = $("#select").val();
        const from = $("#from").val();
        const where = $("#where").val();

        const allowedPattern = /^[a-zA-Z0-9_ *=']*$/;

        console.log(allowedPattern);

        if (!selection.match(allowedPattern) || (!where.match(allowedPattern))){
            console.log("We are in the if!");
            $("#custom-query-results").html("Please type only letters and numbers.");
        } else {
            let executequery = RESTAPI + "/select" + "/" + selection + "/" + from;
            if (where !== "") executequery += "/" + where;
            else executequery += "/none";


            $.get(executequery).then(data => {
                let result = "<tr>"
                for (const name of Object.keys(data[0])) {
                    let newName = ""
                    name.split("_").map(word => {
                        newName += word[0].toUpperCase() + word.substr(1) + " ";
                    })
                    result += "<th>" + newName + "</th>";
                }
                result += "</tr>"
                for (const element of data) {
                    result += "<tr>";
                    var vals = Object.keys(element).map(function (key) {
                        result += "<td>" + element[key] + "</td>";
                    });
                    result += "</tr>";
                }
                $("#custom-query-results").html(result);
            }).fail(() => {
                $("#custom-query-results").html("Error, check your query parameters. <br>" + executequery);
            });
        }
    });

    // Sends a request to the localhost API to query monster cards
    $("#monsterquerysubmit").click(function () {
        const selection = $("#monster_card_type").val();
        let executequery = RESTAPI + "/monster_select" + "/" + selection;

        $.get(executequery).then(data => {
            let result = "<tr>"
            for (const name of Object.keys(data[0])) {
                let newName = ""
                name.split("_").map(word => {
                    newName += word[0].toUpperCase() + word.substr(1) + " ";
                })
                result += "<th>" + newName + "</th>";
            }
            result += "</tr>"
            for (const element of data) {
                result += "<tr>";
                var vals = Object.keys(element).map(function (key) {
                    result += "<td>" + element[key] + "</td>";
                });
                result += "</tr>";
            }
            $("#monster-query-results").html(result);
        }).fail(() => {
            $("#monster-query-results").html("No matches were found under these parameters.");
        });
    });

    // Sends a request to the localhost API to find all monsters with the same attack/defense
    $("#monster_spell_lp_query").click(function () {
        let executequery = RESTAPI + "/example_query/lifepoints";

        $.get(executequery).then(data => {
            let result = "<tr>"
            for (const name of Object.keys(data[0])) {
                let newName = ""
                name.split("_").map(word => {
                    newName += word[0].toUpperCase() + word.substr(1) + " ";
                })
                result += "<th>" + newName + "</th>";
            }
            result += "</tr>"
            for (const element of data) {
                result += "<tr>";
                var vals = Object.keys(element).map(function (key) {
                    result += "<td>" + element[key] + "</td>";
                });
                result += "</tr>";
            }
            $("#trap-query-results").html(result);
        }).fail(() => {
            $("#trap-query-results").html("No matches were found under these parameters.");
        });
    });

    // Sends a request to the localhost API to find all monsters with the same attack/defense
    $("#monster_max_attack_query").click(function () {
        let executequery = RESTAPI + "/example_query/max_attack";

        $.get(executequery).then(data => {
            let result = "<tr>"
            for (const name of Object.keys(data[0])) {
                let newName = ""
                name.split("_").map(word => {
                    newName += word[0].toUpperCase() + word.substr(1) + " ";
                })
                result += "<th>" + newName + "</th>";
            }
            result += "</tr>"
            for (const element of data) {
                result += "<tr>";
                var vals = Object.keys(element).map(function (key) {
                    result += "<td>" + element[key] + "</td>";
                });
                result += "</tr>";
            }
            $("#trap-query-results").html(result);
        }).fail(() => {
            $("#trap-query-results").html("No matches were found under these parameters.");
        });
    });

    $("#monsteratkdefquery").click(function () {
        let executequery = RESTAPI + "/example_query/atk_def";

        $.get(executequery).then(data => {
            let result = "<tr>"
            for (const name of Object.keys(data[0])) {
                let newName = ""
                name.split("_").map(word => {
                    newName += word[0].toUpperCase() + word.substr(1) + " ";
                })
                result += "<th>" + newName + "</th>";
            }
            result += "</tr>"
            for (const element of data) {
                result += "<tr>";
                var vals = Object.keys(element).map(function (key) {
                    result += "<td>" + element[key] + "</td>";
                });
                result += "</tr>";
            }
            $("#trap-query-results").html(result);
        }).fail(() => {
            $("#trap-query-results").html("No matches were found under these parameters.");
        });
    });

    // Sends a request to the localhost API to find all monsters with the same attack/defense
    $("#monstercountrarityquery").click(function () {
        let executequery = RESTAPI + "/example_query/count_rarity";

        $.get(executequery).then(data => {
            let result = "<tr>"
            for (const name of Object.keys(data[0])) {
                let newName = ""
                name.split("_").map(word => {
                    newName += word[0].toUpperCase() + word.substr(1) + " ";
                })
                result += "<th>" + newName + "</th>";
            }
            result += "</tr>"
            for (const element of data) {
                result += "<tr>";
                var vals = Object.keys(element).map(function (key) {
                    result += "<td>" + element[key] + "</td>";
                });
                result += "</tr>";
            }
            $("#trap-query-results").html(result);
        }).fail(() => {
            $("#trap-query-results").html("No matches were found under these parameters.");
        });
    });

    // Sends a request to the localhost API to search for monster cards by name
    $("#monsterquerynamesubmit").click(function () {
        const monster_card_name = $("#monster_card_name").val();
        if (monster_card_name !== "") {
            let executequery = RESTAPI + "/special_select/card_name, attack, defense, card_type, monster_level/monster_cards/" + monster_card_name;
            $.get(executequery).then(data => {
                let result = "<tr>"
                for (const name of Object.keys(data[0])) {
                    let newName = ""
                    name.split("_").map(word => {
                        newName += word[0].toUpperCase() + word.substr(1) + " ";
                    })
                    result += "<th>" + newName + "</th>";
                }
                result += "</tr>"
                for (const element of data) {
                    result += "<tr>";
                    var vals = Object.keys(element).map(function (key) {
                        result += "<td>" + element[key] + "</td>";
                    });
                    result += "</tr>";
                }
                $("#monster-query-results").html(result);
            }).fail(() => {
                $("#monster-query-results").html("No matches found. <br>");
            });
        } else {
            $("#monster-query-results").html("Error, check your query parameters. <br>");
        }

    });



    //TODO implement regex on queries; example below
    
//     app.get('/repositories/:userQuery', async (req, res) => {


//     const {userQuery} = req.params;
//     const onlyLettersPattern = /^[A-Za-z0-9\*]+$/;


//     if(!userQuery.match(onlyLettersPattern)){
//       return res.status(400).json({ err: "No special characters and no numbers, please!"})
//     }


//     ...
//   });

</script>

</html>
